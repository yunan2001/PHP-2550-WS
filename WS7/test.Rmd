---
title: "test"
author: "Yunan Chen"
date: "2024-10-17"
output: pdf_document
---

```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(moments))
suppressPackageStartupMessages(library(stats))
library(dplyr)
library(gtsummary)
library(gt)
library(tidyverse)
library(corrplot)
library(RColorBrewer)
library(grDevices)
library(ggcorrplot)
# kidney_df <- read.csv("baseseg.csv")
# kidney_df <- kidney_df %>% 
#   select(c(gfr, bascre, sbase, dbase, baseu, AGE, SEX, black)) %>%
#   rename(sex = SEX, age = AGE) %>%
#   na.omit()
# kidney_df$black <- as.factor(kidney_df$black)
# kidney_df$sex <- as.factor(kidney_df$sex)
```

```{r}
kidney_tbl <- kidney_df %>%
  mutate(black = recode(black, `0` = "Non-Black", `1` ="Black"),
         sex = recode(sex, `0` = "Female", `1` ="Male")) %>%
  tbl_summary(by=black,
              label = list(gfr ~ "Measured glomerular filtration rate",
                           bascre ~ "Base serum Creatinine",
                           sbase ~ "Systolic blood pressure",
                           dbase ~ " Diastolic blood pressure",
                           baseu ~ "Urine protein"
                           ),
              statistic = all_continuous() ~ "{mean} ({sd})") %>%
  modify_spanning_header(update =  all_stat_cols() ~  "**Black**") %>%
  modify_footnote(update = all_stat_cols() ~ "Mean (SD) for continuous; n (%) for categorical") %>%
  bold_labels()
kidney_tbl
```

```{r}
cor_m <-cor(kidney_df[, -c(2, 5, 7,8)])
variable_order <- c("log_baseu", "log_bascre", "dbase", "sbase", "age", "gfr")
r_reordered <- cor_m[variable_order, variable_order]

ggcorrplot(r_reordered, 
           hc.order = TRUE, 
           type = "lower",
           lab = TRUE) +
  ggtitle("Figure 2: Correlation Matrix") +
  theme(plot.title = element_text(hjust = 0.5, size=14),
        axis.text.x = element_text(size = 12),             
        axis.text.y = element_text(size = 12))
```
# 3
```{r}
library(caret)
set.seed(2550)
index <- createDataPartition(kidney_df$gfr, p=0.8, list=FALSE)
train <- kidney_df[index, ]
test <- kidney_df[-index, ]
m1 <- glm(gfr ~ age + log_bascre, family=gaussian, data=train)
predictions <- predict(m1, newdata = test)
mse <- mean((predictions-test$gfr)^2)
mae <- mean(abs(predictions-test$gfr))

cat("The MSE is:", mse, "\n")
cat("The MAE is:", mae, "\n")
```

# 4
```{r}
# Split data by race and calculate performance metrics
test$estimated_gfr <- predict(m1, newdata = test)
performance_by_race <- test %>%
  group_by(black) %>%
  summarise(MSE = mean((gfr - estimated_gfr)^2),
            Bias = mean(estimated_gfr - gfr),
            P10 = mean(abs(estimated_gfr - gfr) / gfr <= 0.10) * 100,
            P30 = mean(abs(estimated_gfr - gfr) / gfr <= 0.30) * 100)
performance_by_race %>%
  kbl(caption = "Performance Metrics by Race") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

# Create a scatter plot to compare measured and estimated GFR
ggplot(test, aes(x = gfr, y = estimated_gfr, color = black)) +
  geom_point(alpha=0.8) +
  geom_abline(intercept = 0, slope = 1, linetype = "solid", color = "black", size=1) +  # Perfect prediction line
  geom_smooth(method = "lm", linetype = "dashed", se = FALSE, alpha=0.8) + 
  scale_color_manual(values = c("0" = "red", "1" = "blue"),  # Assign colors manually
                     labels = c("0" = "Non-black", "1" = "Black"),  # Rename legend labels
                     name = "Race") +
  labs(title = "Comparison of Measured and Estimated GFR by Race",
       x = "Measured GFR",
       y = "Estimated GFR") +
  theme_minimal()
```